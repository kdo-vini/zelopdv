import{s as _e,n as le,r as pe,o as ve,d as be}from"../chunks/DUJQqtHE.js";import{S as ge,i as Ce,d as _,u as K,a as U,b as i,v as Y,o as m,c as p,p as R,g as y,e as x,h,j as P,s as $,f as Q,t as W,w as Ee,x as he,y as re,z as we}from"../chunks/CBbGAyDJ.js";import{e as ne}from"../chunks/BMMEC0mH.js";import{s as G}from"../chunks/BxpIoVra.js";function ae(r,e,s){const t=r.slice();return t[21]=e[s],t}function ie(r,e,s){const t=r.slice();return t[24]=e[s],t}function oe(r){let e,s;return{c(){e=h("div"),s=W(r[4]),this.h()},l(t){e=p(t,"DIV",{class:!0});var l=x(e);s=Q(l,r[4]),l.forEach(_),this.h()},h(){m(e,"class","mb-4 text-sm text-red-600")},m(t,l){U(t,e,l),i(e,s)},p(t,l){l&16&&$(s,t[4])},d(t){t&&_(e)}}}function ke(r){let e,s=ne(r[0]),t=[];for(let l=0;l<s.length;l+=1)t[l]=me(ae(r,s,l));return{c(){e=h("div");for(let l=0;l<t.length;l+=1)t[l].c();this.h()},l(l){e=p(l,"DIV",{class:!0});var a=x(e);for(let n=0;n<t.length;n+=1)t[n].l(a);a.forEach(_),this.h()},h(){m(e,"class","space-y-6")},m(l,a){U(l,e,a);for(let n=0;n<t.length;n+=1)t[n]&&t[n].m(e,null)},p(l,a){if(a&7623){s=ne(l[0]);let n;for(n=0;n<s.length;n+=1){const d=ae(l,s,n);t[n]?t[n].p(d,a):(t[n]=me(d),t[n].c(),t[n].m(e,null))}for(;n<t.length;n+=1)t[n].d(1);t.length=s.length}},d(l){l&&_(e),he(t,l)}}}function Ie(r){let e,s="Você ainda não participa de nenhuma empresa.";return{c(){e=h("div"),e.textContent=s,this.h()},l(t){e=p(t,"DIV",{class:!0,"data-svelte-h":!0}),R(e)!=="svelte-4cr0rc"&&(e.textContent=s),this.h()},h(){m(e,"class","text-sm text-slate-500")},m(t,l){U(t,e,l)},p:le,d(t){t&&_(e)}}}function je(r){let e,s="Carregando...";return{c(){e=h("div"),e.textContent=s},l(t){e=p(t,"DIV",{"data-svelte-h":!0}),R(e)!=="svelte-btlswi"&&(e.textContent=s)},m(t,l){U(t,e,l)},p:le,d(t){t&&_(e)}}}function ue(r){let e,s,t=r[21].cnpj+"",l;return{c(){e=h("div"),s=W("CNPJ: "),l=W(t),this.h()},l(a){e=p(a,"DIV",{class:!0});var n=x(e);s=Q(n,"CNPJ: "),l=Q(n,t),n.forEach(_),this.h()},h(){m(e,"class","text-xs text-slate-500")},m(a,n){U(a,e,n),i(e,s),i(e,l)},p(a,n){n&1&&t!==(t=a[21].cnpj+"")&&$(l,t)},d(a){a&&_(e)}}}function ce(r){let e,s="Remover",t,l;function a(){return r[15](r[21],r[24])}return{c(){e=h("button"),e.textContent=s,this.h()},l(n){e=p(n,"BUTTON",{class:!0,"data-svelte-h":!0}),R(e)!=="svelte-1fvcaw3"&&(e.textContent=s),this.h()},h(){m(e,"class","btn-secondary")},m(n,d){U(n,e,d),t||(l=Y(e,"click",a),t=!0)},p(n,d){r=n},d(n){n&&_(e),t=!1,l()}}}function fe(r){let e,s,t=r[24].id_usuario+"",l,a,n,d=r[24].role+"",M,b,w=r[10](r[21].id),k,g=w&&ce(r);return{c(){e=h("li"),s=h("span"),l=W(t),a=P(),n=h("span"),M=W(d),b=P(),g&&g.c(),k=P(),this.h()},l(v){e=p(v,"LI",{class:!0});var f=x(e);s=p(f,"SPAN",{class:!0});var T=x(s);l=Q(T,t),T.forEach(_),a=y(f),n=p(f,"SPAN",{class:!0});var A=x(n);M=Q(A,d),A.forEach(_),b=y(f),g&&g.l(f),k=y(f),f.forEach(_),this.h()},h(){m(s,"class","text-slate-600"),m(n,"class","text-slate-800 font-medium"),m(e,"class","flex items-center justify-between text-sm")},m(v,f){U(v,e,f),i(e,s),i(s,l),i(e,a),i(e,n),i(n,M),i(e,b),g&&g.m(e,null),i(e,k)},p(v,f){f&3&&t!==(t=v[24].id_usuario+"")&&$(l,t),f&3&&d!==(d=v[24].role+"")&&$(M,d),f&1&&(w=v[10](v[21].id)),w?g?g.p(v,f):(g=ce(v),g.c(),g.m(e,k)):g&&(g.d(1),g=null)},d(v){v&&_(e),g&&g.d()}}}function de(r){let e,s,t,l,a,n="Atendente",d,M="Admin",b,w,k="Adicionar",g,v,f="Dica: o usuário precisa ter uma conta com este e-mail. A função localizará o usuário e criará/atualizará a permissão.",T,A;function L(){return r[18](r[21])}return{c(){e=h("form"),s=h("input"),t=P(),l=h("select"),a=h("option"),a.textContent=n,d=h("option"),d.textContent=M,b=P(),w=h("button"),w.textContent=k,g=P(),v=h("p"),v.textContent=f,this.h()},l(D){e=p(D,"FORM",{class:!0});var V=x(e);s=p(V,"INPUT",{placeholder:!0,type:!0,class:!0}),t=y(V),l=p(V,"SELECT",{class:!0});var O=x(l);a=p(O,"OPTION",{"data-svelte-h":!0}),R(a)!=="svelte-1vq73li"&&(a.textContent=n),d=p(O,"OPTION",{"data-svelte-h":!0}),R(d)!=="svelte-17op260"&&(d.textContent=M),O.forEach(_),b=y(V),w=p(V,"BUTTON",{class:!0,"data-svelte-h":!0}),R(w)!=="svelte-1y6oz4g"&&(w.textContent=k),V.forEach(_),g=y(D),v=p(D,"P",{class:!0,"data-svelte-h":!0}),R(v)!=="svelte-os5541"&&(v.textContent=f),this.h()},h(){m(s,"placeholder","E-mail do usuário"),m(s,"type","email"),m(s,"class","input-form"),a.__value="atendente",K(a,a.__value),d.__value="admin",K(d,d.__value),m(l,"class","input-form"),r[8]===void 0&&be(()=>r[17].call(l)),m(w,"class","btn-primary"),m(e,"class","mt-4 grid md:grid-cols-3 gap-2"),m(v,"class","text-xs text-slate-500 mt-1")},m(D,V){U(D,e,V),i(e,s),K(s,r[7]),i(e,t),i(e,l),i(l,a),i(l,d),re(l,r[8],!0),i(e,b),i(e,w),U(D,g,V),U(D,v,V),T||(A=[Y(s,"input",r[16]),Y(l,"change",r[17]),Y(e,"submit",we(L))],T=!0)},p(D,V){r=D,V&128&&s.value!==r[7]&&K(s,r[7]),V&256&&re(l,r[8])},d(D){D&&(_(e),_(g),_(v)),T=!1,pe(A)}}}function me(r){let e,s,t,l,a=r[21].nome+"",n,d,M,b,w,k=r[2].get(r[21].id)+"",g,v,f,T,A="Membros",L,D,V,O=r[10](r[21].id),F,I=r[21].cnpj&&ue(r),J=ne(r[1].get(r[21].id)||[]),o=[];for(let c=0;c<J.length;c+=1)o[c]=fe(ie(r,J,c));let u=O&&de(r);return{c(){e=h("div"),s=h("div"),t=h("div"),l=h("div"),n=W(a),d=P(),I&&I.c(),M=P(),b=h("div"),w=W("Minha função: "),g=W(k),v=P(),f=h("div"),T=h("h3"),T.textContent=A,L=P(),D=h("ul");for(let c=0;c<o.length;c+=1)o[c].c();V=P(),u&&u.c(),F=P(),this.h()},l(c){e=p(c,"DIV",{class:!0});var N=x(e);s=p(N,"DIV",{class:!0});var C=x(s);t=p(C,"DIV",{});var z=x(t);l=p(z,"DIV",{class:!0});var S=x(l);n=Q(S,a),S.forEach(_),d=y(z),I&&I.l(z),z.forEach(_),M=y(C),b=p(C,"DIV",{class:!0});var j=x(b);w=Q(j,"Minha função: "),g=Q(j,k),j.forEach(_),C.forEach(_),v=y(N),f=p(N,"DIV",{class:!0});var B=x(f);T=p(B,"H3",{class:!0,"data-svelte-h":!0}),R(T)!=="svelte-1bzmj6t"&&(T.textContent=A),L=y(B),D=p(B,"UL",{class:!0});var X=x(D);for(let H=0;H<o.length;H+=1)o[H].l(X);X.forEach(_),V=y(B),u&&u.l(B),B.forEach(_),F=y(N),N.forEach(_),this.h()},h(){m(l,"class","font-medium"),m(b,"class","text-xs rounded px-2 py-1 border bg-white dark:bg-slate-800"),m(s,"class","p-4 flex items-center justify-between"),m(T,"class","font-semibold mb-2"),m(D,"class","space-y-2"),m(f,"class","p-4 border-t"),m(e,"class","border rounded-md")},m(c,N){U(c,e,N),i(e,s),i(s,t),i(t,l),i(l,n),i(t,d),I&&I.m(t,null),i(s,M),i(s,b),i(b,w),i(b,g),i(e,v),i(e,f),i(f,T),i(f,L),i(f,D);for(let C=0;C<o.length;C+=1)o[C]&&o[C].m(D,null);i(f,V),u&&u.m(f,null),i(e,F)},p(c,N){if(N&1&&a!==(a=c[21].nome+"")&&$(n,a),c[21].cnpj?I?I.p(c,N):(I=ue(c),I.c(),I.m(t,null)):I&&(I.d(1),I=null),N&5&&k!==(k=c[2].get(c[21].id)+"")&&$(g,k),N&5123){J=ne(c[1].get(c[21].id)||[]);let C;for(C=0;C<J.length;C+=1){const z=ie(c,J,C);o[C]?o[C].p(z,N):(o[C]=fe(z),o[C].c(),o[C].m(D,null))}for(;C<o.length;C+=1)o[C].d(1);o.length=J.length}N&1&&(O=c[10](c[21].id)),O?u?u.p(c,N):(u=de(c),u.c(),u.m(f,null)):u&&(u.d(1),u=null)},d(c){c&&_(e),I&&I.d(),he(o,c),u&&u.d()}}}function Me(r){let e,s="Empresas",t,l,a,n,d="Criar nova empresa",M,b,w,k,g="Nome",v,f,T,A,L,D="CNPJ (opcional)",V,O,F,I,J='<button class="btn-primary">Criar Empresa</button>',o,u,c,N="Minhas empresas",C,z,S,j=r[4]&&oe(r);function B(E,q){return E[3]?je:E[0].length===0?Ie:ke}let X=B(r),H=X(r);return{c(){e=h("h1"),e.textContent=s,t=P(),j&&j.c(),l=P(),a=h("section"),n=h("h2"),n.textContent=d,M=P(),b=h("form"),w=h("div"),k=h("label"),k.textContent=g,v=P(),f=h("input"),T=P(),A=h("div"),L=h("label"),L.textContent=D,V=P(),O=h("input"),F=P(),I=h("div"),I.innerHTML=J,o=P(),u=h("section"),c=h("h2"),c.textContent=N,C=P(),H.c(),this.h()},l(E){e=p(E,"H1",{class:!0,"data-svelte-h":!0}),R(e)!=="svelte-1xup00i"&&(e.textContent=s),t=y(E),j&&j.l(E),l=y(E),a=p(E,"SECTION",{class:!0});var q=x(a);n=p(q,"H2",{class:!0,"data-svelte-h":!0}),R(n)!=="svelte-ar0ebp"&&(n.textContent=d),M=y(q),b=p(q,"FORM",{class:!0});var Z=x(b);w=p(Z,"DIV",{});var ee=x(w);k=p(ee,"LABEL",{for:!0,class:!0,"data-svelte-h":!0}),R(k)!=="svelte-vwoq9l"&&(k.textContent=g),v=y(ee),f=p(ee,"INPUT",{id:!0,class:!0}),ee.forEach(_),T=y(Z),A=p(Z,"DIV",{});var te=x(A);L=p(te,"LABEL",{for:!0,class:!0,"data-svelte-h":!0}),R(L)!=="svelte-1ntqrob"&&(L.textContent=D),V=y(te),O=p(te,"INPUT",{id:!0,class:!0}),te.forEach(_),F=y(Z),I=p(Z,"DIV",{class:!0,"data-svelte-h":!0}),R(I)!=="svelte-p73fhr"&&(I.innerHTML=J),Z.forEach(_),q.forEach(_),o=y(E),u=p(E,"SECTION",{class:!0});var se=x(u);c=p(se,"H2",{class:!0,"data-svelte-h":!0}),R(c)!=="svelte-23jgod"&&(c.textContent=N),C=y(se),H.l(se),se.forEach(_),this.h()},h(){m(e,"class","text-2xl font-semibold mb-4"),m(n,"class","font-semibold mb-3"),m(k,"for","empresa-nome"),m(k,"class","block text-sm mb-1"),m(f,"id","empresa-nome"),m(f,"class","input-form"),f.required=!0,m(L,"for","empresa-cnpj"),m(L,"class","block text-sm mb-1"),m(O,"id","empresa-cnpj"),m(O,"class","input-form"),m(I,"class","md:col-span-2"),m(b,"class","grid md:grid-cols-2 gap-4"),m(a,"class","mb-8 bg-white dark:bg-slate-800 rounded-lg shadow p-4"),m(c,"class","font-semibold mb-3"),m(u,"class","bg-white dark:bg-slate-800 rounded-lg shadow p-4")},m(E,q){U(E,e,q),U(E,t,q),j&&j.m(E,q),U(E,l,q),U(E,a,q),i(a,n),i(a,M),i(a,b),i(b,w),i(w,k),i(w,v),i(w,f),K(f,r[5].nome),i(b,T),i(b,A),i(A,L),i(A,V),i(A,O),K(O,r[5].cnpj),i(b,F),i(b,I),U(E,o,q),U(E,u,q),i(u,c),i(u,C),H.m(u,null),z||(S=[Y(f,"input",r[13]),Y(O,"input",r[14]),Y(b,"submit",r[9])],z=!0)},p(E,[q]){E[4]?j?j.p(E,q):(j=oe(E),j.c(),j.m(l.parentNode,l)):j&&(j.d(1),j=null),q&32&&f.value!==E[5].nome&&K(f,E[5].nome),q&32&&O.value!==E[5].cnpj&&K(O,E[5].cnpj),X===(X=B(E))&&H?H.p(E,q):(H.d(1),H=X(E),H&&(H.c(),H.m(u,null)))},i:le,o:le,d(E){E&&(_(e),_(t),_(l),_(a),_(o),_(u)),j&&j.d(E),H.d(),z=!1,pe(S)}}}function De(r,e,s){let t=[],l=new Map,a=new Map,n=!0,d="",M={nome:"",cnpj:""},b=null,w="",k="atendente";ve(async()=>{await v(),s(3,n=!1)});async function g(){var u;const{data:o}=await G.auth.getUser();return((u=o==null?void 0:o.user)==null?void 0:u.id)??null}async function v(){try{s(4,d="");const o=await g();if(!o){window.location.href="/login";return}const{data:u,error:c}=await G.from("empresa_usuarios").select("id_empresa, role").eq("id_usuario",o);if(c)throw c;const N=u.map(S=>S.id_empresa);s(2,a=new Map(u.map(S=>[S.id_empresa,S.role])));let C=[];if(N.length){const{data:S,error:j}=await G.from("empresas").select("*").in("id",N).order("id",{ascending:!0});if(j)throw j;C=S}s(0,t=C);const z=new Map;for(const S of t){const{data:j,error:B}=await G.from("empresa_usuarios").select("id_usuario, role").eq("id_empresa",S.id).order("role");if(B)throw B;z.set(S.id,j)}s(1,l=z)}catch(o){s(4,d=(o==null?void 0:o.message)??"Erro ao carregar empresas.")}}async function f(o){o.preventDefault();const u=await g();if(!u)return;const{data:c,error:N}=await G.from("empresas").insert({nome:M.nome,cnpj:M.cnpj||null,id_owner:u}).select("id").single();if(N){s(4,d=N.message);return}const{error:C}=await G.from("empresa_usuarios").insert({id_empresa:c.id,id_usuario:u,role:"admin"});if(C){s(4,d=C.message);return}s(5,M={nome:"",cnpj:""}),await v()}function T(o){return a.get(o)==="admin"}async function A(o){if(o.preventDefault(),!b||!w)return;if(!T(b)){s(4,d="Acesso negado.");return}const{error:u}=await G.rpc("add_empresa_membro_por_email",{p_id_empresa:b,p_email:w.trim(),p_role:k});if(u){s(4,d=u.message);return}s(7,w=""),s(8,k="atendente"),await v()}async function L(o,u){if(!T(o)){s(4,d="Acesso negado.");return}if(!confirm("Remover este membro?"))return;const{error:c}=await G.from("empresa_usuarios").delete().eq("id_empresa",o).eq("id_usuario",u);if(c){s(4,d=c.message);return}await v()}function D(){M.nome=this.value,s(5,M)}function V(){M.cnpj=this.value,s(5,M)}const O=(o,u)=>L(o.id,u.id_usuario);function F(){w=this.value,s(7,w)}function I(){k=Ee(this),s(8,k)}return[t,l,a,n,d,M,b,w,k,f,T,A,L,D,V,O,F,I,o=>{s(6,b=o.id),A(new Event("submit"))}]}class Pe extends ge{constructor(e){super(),Ce(this,e,De,Me,_e,{})}}export{Pe as component};
