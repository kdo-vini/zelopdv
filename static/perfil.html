<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zelo PDV · Perfil da Empresa</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--text:#e2e8f0;--brand:#0284c7;--brand-2:#0369a1;--danger:#ef4444;--ok:#22c55e;--border:#1f2937
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);margin:0;}
    header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .container{max-width:900px;margin:0 auto;padding:24px}
    .title{font-size:22px;font-weight:700;margin:0}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin-top:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:14px;margin:8px 0;color:#cbd5e1}
    input,select,textarea{width:100%;background:#0a0f1c;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:10px 12px;outline:none}
    textarea{min-height:80px}
    .hint{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:12px;align-items:center;margin-top:16px}
    .btn{background:var(--brand);border:none;border-radius:8px;color:#fff;padding:10px 16px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    .alert{padding:12px 14px;border-radius:10px;margin:16px 0;font-size:14px}
    .alert.warn{background:#1f2937;color:#eab308}
    .alert.err{background:#1f2937;color:#fca5a5}
    .alert.ok{background:#052e1a;color:#86efac;border:1px solid #14532d}
    .logo-wrap{display:flex;gap:16px;align-items:center}
    .logo{width:72px;height:72px;border-radius:8px;border:1px solid var(--border);background:#0a0f1c;object-fit:contain}
    .sr-only{position:absolute;left:-9999px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <h1 class="title">Perfil da Empresa</h1>
        <div id="msgGlobal" class="hint"></div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <a class="btn secondary" href="/app">Voltar ao App</a>
        <button id="btnLogout" class="btn secondary">Sair</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="alert" class="alert warn" style="display:none"></div>

    <div class="panel">
      <div class="row row-1">
        <label>
          Nome exibido no recibo *
          <input id="nome_exibicao" placeholder="Ex.: Zelo Comércio LTDA" />
        </label>
      </div>
      <div class="row">
        <label>
          Documento (CNPJ/CPF) *
          <input id="documento" placeholder="CNPJ ou CPF" />
        </label>
        <label>
          Contato (telefone ou e-mail) *
          <input id="contato" placeholder="(11) 99999-9999 ou contato@empresa.com" />
        </label>
      </div>
      <div class="row">
        <label>
          Inscrição Estadual (opcional)
          <input id="inscricao_estadual" placeholder="ISENTO quando aplicável" />
        </label>
        <label>
          Largura da bobina *
          <select id="largura_bobina">
            <option value="80mm">80 mm</option>
            <option value="58mm">58 mm</option>
          </select>
        </label>
      </div>
      <div class="row row-1">
        <label>
          Endereço (opcional)
          <input id="endereco" placeholder="Rua, número - bairro - cidade/UF" />
        </label>
      </div>
      <div class="row row-1">
        <label>
          Logo da empresa (opcional)
          <div class="logo-wrap">
            <img id="logo_preview" class="logo" alt="Logo" />
            <div>
              <input id="logo_file" type="file" accept="image/*" />
              <div class="hint">Formato recomendado: PNG quadrado (até 1MB)</div>
              <div id="logo_status" class="hint"></div>
            </div>
          </div>
        </label>
      </div>
      <div class="row row-1">
        <label>
          Rodapé do recibo (opcional)
          <textarea id="rodape_recibo" placeholder="Obrigado pela preferência!"></textarea>
        </label>
      </div>

      <div class="actions">
        <button id="btnSalvar" class="btn" disabled>Salvar alterações</button>
        <div id="saveStatus" class="hint"></div>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const alertBox = document.getElementById('alert');
    const msgGlobal = document.getElementById('msgGlobal');
    const btnSalvar = document.getElementById('btnSalvar');

    const $ = id => document.getElementById(id);
    const state = {
      supabase: null,
      user: null,
      perfil: null,
      bucket: 'logos',
      logoPath: null,
    };

    function showAlert(text, kind='warn'){
      alertBox.textContent = text;
      alertBox.className = 'alert ' + kind;
      alertBox.style.display = 'block';
    }
    function hideAlert(){ alertBox.style.display = 'none'; }

    function isValid(){
      const nome = $('nome_exibicao').value.trim();
      const doc = $('documento').value.trim();
      const contato = $('contato').value.trim();
      const largura = $('largura_bobina').value;
      return nome && doc && contato && (largura === '58mm' || largura === '80mm');
    }

    function refreshButton(){ btnSalvar.disabled = !isValid(); }

    async function fetchPublicEnv(){
      const r = await fetch('/api/public-env');
      if(!r.ok){ throw new Error('Falha ao obter configuração pública'); }
      return await r.json();
    }

    async function initSupabase(){
      const env = await fetchPublicEnv();
      if(!env.supabaseUrl || !env.supabaseAnonKey){
        throw new Error('Configuração Supabase ausente. Defina VITE_PUBLIC_SUPABASE_URL e VITE_PUBLIC_SUPABASE_ANON_KEY.');
      }
      state.supabase = window.supabase.createClient(env.supabaseUrl, env.supabaseAnonKey, {
        auth: { persistSession: true, autoRefreshToken: true }
      });
    }

    async function requireSession(){
      const { data: { session } } = await state.supabase.auth.getSession();
      if(!session){ window.location.href = '/login'; return null; }
      state.user = session.user;
      return session;
    }

    async function carregarPerfil(){
      const { data, error } = await state.supabase
        .from('empresa_perfil')
        .select('*')
        .eq('user_id', state.user.id)
        .maybeSingle();

      if(error){ console.error('Erro ao carregar perfil', error); showAlert('Erro ao carregar perfil.', 'err'); return; }

      // Não insere registro vazio: a tabela exige campos NOT NULL (nome_exibicao, documento, contato).
      // Se não houver registro, mantém null e o primeiro SALVAR fará o upsert completo.
      state.perfil = data || null;

      preencherFormulario();
    }

    function preencherFormulario(){
      const p = state.perfil || {};
      $('nome_exibicao').value = p.nome_exibicao || '';
      $('documento').value = p.documento || '';
      $('contato').value = p.contato || '';
      $('inscricao_estadual').value = p.inscricao_estadual || '';
      $('endereco').value = p.endereco || '';
      $('largura_bobina').value = p.largura_bobina || '80mm';
      $('rodape_recibo').value = p.rodape_recibo || 'Obrigado pela preferência!';
      if(p.logo_url){ $('logo_preview').src = p.logo_url; }
      refreshButton();
    }

    async function uploadLogo(file){
      if(!file){ return; }
      // Upload direto no bucket 'logos' na raiz, sem prefixos extras
      const path = `${state.user.id}.png`;
      $('logo_status').textContent = 'Enviando logo…';
      const { error } = await state.supabase
        .storage.from(state.bucket)
        .upload(path, file, { upsert: true, contentType: file.type || 'image/png' });
      if(error){ $('logo_status').textContent = 'Falha no upload.'; showAlert('Erro ao enviar logo.', 'err'); return; }
      const { data } = state.supabase.storage.from(state.bucket).getPublicUrl(path);
      const url = data.publicUrl;
      $('logo_preview').src = url;
      $('logo_status').textContent = 'Logo atualizada.';
      // Se já existe perfil, persiste logo_url imediatamente; caso contrário, guardamos para salvar junto no upsert do perfil.
      if(state.perfil){
        await state.supabase.from('empresa_perfil').upsert({ user_id: state.user.id, logo_url: url }, { onConflict: 'user_id' });
        state.perfil.logo_url = url;
      } else {
        state.pendingLogoUrl = url;
      }
    }

    async function salvarPerfil(){
      if(!isValid()){ showAlert('Preencha os campos obrigatórios.', 'warn'); return; }
      hideAlert();
      btnSalvar.disabled = true; $('saveStatus').textContent = 'Salvando…';
      const payload = {
        user_id: state.user.id,
        nome_exibicao: $('nome_exibicao').value.trim(),
        documento: $('documento').value.trim(),
        contato: $('contato').value.trim(),
        inscricao_estadual: $('inscricao_estadual').value.trim() || null,
        endereco: $('endereco').value.trim() || null,
        rodape_recibo: $('rodape_recibo').value.trim() || 'Obrigado pela preferência!',
        largura_bobina: $('largura_bobina').value,
        logo_url: (state.pendingLogoUrl || (state.perfil && state.perfil.logo_url) || ($('logo_preview').src || null)) || null,
        updated_at: new Date().toISOString()
      };
      const { error } = await state.supabase
        .from('empresa_perfil')
        .upsert(payload, { onConflict: 'user_id' });

      if(error){ $('saveStatus').textContent = ''; showAlert('Erro ao salvar perfil.', 'err'); btnSalvar.disabled = false; return; }
      $('saveStatus').textContent = 'Perfil salvo com sucesso.';
      setTimeout(()=>{ window.location.href = '/painel.html'; }, 600);
    }

    function wireEvents(){
      ['nome_exibicao','documento','contato','largura_bobina'].forEach(id=>{
        $(id).addEventListener('input', refreshButton);
        $(id).addEventListener('change', refreshButton);
      });
      $('logo_file').addEventListener('change', (e)=> uploadLogo(e.target.files?.[0]));
      $('btnSalvar').addEventListener('click', salvarPerfil);
      $('btnLogout').addEventListener('click', async ()=>{
        try{
          if(state.supabase){ await state.supabase.auth.signOut(); }
        }catch(err){ console.warn('logout error', err); }
        window.location.href = '/login';
      });
    }

    function verificarPerfilCompletoLocal(){
      if(!state.perfil) return false;
      const p = state.perfil;
      return Boolean(p.nome_exibicao && p.documento && p.contato && (p.largura_bobina==='58mm' || p.largura_bobina==='80mm'));
    }

    function maybeShowCompleteMsg(){
      const url = new URL(window.location.href);
      if(url.searchParams.get('msg')){
        showAlert('Complete as informações da sua empresa antes de continuar.', 'warn');
      } else if(!verificarPerfilCompletoLocal()){
        showAlert('Preencha os campos obrigatórios marcados com *.', 'warn');
      }
    }

    async function bootstrap(){
      try{
        await initSupabase();
        const session = await requireSession();
        if(!session) return;
        wireEvents();
        await carregarPerfil();
        maybeShowCompleteMsg();
      }catch(err){
        console.error(err);
        showAlert(err.message || 'Falha ao iniciar página.', 'err');
      }
    }

    bootstrap();
  })();
  </script>
</body>
</html>
